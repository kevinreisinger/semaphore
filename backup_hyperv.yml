---
- name: Execute Remote HyperV VSS Backup Script
  hosts: server2k25.reisingers.com
  gather_facts: false
  
  vars:
    # Variables for the PowerShell script arguments
    target_volume: 'C' 
    source_dir: 'C:\ProgramData\Microsoft\Windows\Virtual Hard Disks'
    dest_dir: 'N:\Virtual Hard Disks'
    
    # Path where the script is located on the Windows server
    remote_script_path: 'C:\Windows\Scripts\backup_hyperv.ps1' 
    
  tasks:
    - name: ğŸ“ Ensure the C:\Windows\Scripts directory exists
      ansible.windows.win_file:
        path: C:\Windows\Scripts
        state: directory
        
    - name: âš™ï¸ Execute the remote VSS copy script using free-form win_shell
      # ğŸ¯ FIX: Removing 'win_shell:' and 'cmd: |' and using the free-form string
      ansible.windows.win_shell: |
          & "{{ remote_script_path }}" `
          -SourcePath '{{ source_dir }}' `
          -DestinationPath '{{ dest_dir }}' `
          -Volume '{{ target_volume }}'
      register: script_output
      
    - name: ğŸ–¥ï¸ Display script output
      ansible.builtin.debug:
        var: script_output.stdout_lines
