---
- name: Copy Virtual Hard Disks folder to N:\ with overwrite
  hosts: server2k25
  gather_facts: no

  vars:
    source_path: "C:\\ProgramData\\Microsoft\\Windows\\Virtual Hard Disks"
    dest_path:   "N:\\Virtual Hard Disks"

  tasks:

    - name: Ensure destination folder exists
      win_file:
        path: "{{ dest_path }}"
        state: directory

    - name: Copy VHDX files using robocopy (with overwrite)
      win_command: >
        robocopy "{{ source_path }}" "{{ dest_path }}"
        /MIR /R:3 /W:5 /NFL /NDL /NP /TEE
      register: robocopy_result
      changed_when: "'Copied' in robocopy_result.stdout or 'Newer' in robocopy_result.stdout"

    - name: Show robocopy output
      debug:
        var: robocopy_result.stdout
