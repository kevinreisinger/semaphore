---
- name: 1. API Trigger Jellyfin Backup (Run on Controller)
  hosts: localhost
  connection: local
  gather_facts: no
  
  vars:
    jellyfin_url: "http://server2k19.reisingers.com:8096"
    jellyfin_api_key: "ba76d7d9312744a89f6ba3ed85a20921"

  # ğŸ”‘ FINAL FIX: Explicitly set the connection user at the play level 
  # This tells Ansible to use the local SSH/system user, fully overriding any inherited WinRM settings.
  ansible_user: "" 
  
  tasks:
    - name: ğŸ“ Trigger Jellyfin Built-in Backup via API
      ansible.builtin.uri:
        url: "{{ jellyfin_url }}/Backup/Create"
        method: POST
        headers:
          X-MediaBrowser-Token: "{{ jellyfin_api_key }}"
          Content-Type: application/json
        body: '{"Metadata": true, "Trickplay": false, "Subtitles": false, "Database": true}'
        body_format: json
        status_code: 200
      register: backup_trigger_result
      
# ---------------------------------------------------------------------------------------

- name: 2. Copy Backup to Network Share and Cleanup (Run on Windows Host)
  hosts: server2k19.reisingers.com
  gather_facts: yes
  
  vars:
    local_backup_path: "C:\\ProgramData\\Jellyfin\\Server\\data\\backups" 
    network_share_path: "\\\\kevireis-home\\i$\\Applications\\Jellyfin\\Backup"
    temp_zip_pattern: 'jellyfin-backup-*.zip'
    
    share_username: "" 
    share_password: "" 
    retention_days: 7

  tasks:
    - name: ğŸ” Find the newest backup file (wait up to 5 minutes for creation)
      ansible.windows.win_find:
        paths: "{{ local_backup_path }}"
        file_type: file
        pattern: "{{ temp_zip_pattern }}"
        sort_by: ctime
        sort_order: desc
      register: found_files
      until: found_files.files | length > 0 and (found_files.files[0].creation_time | to_datetime) > (ansible_date_time.epoch | int - 300) | to_datetime(format='%s')
      retries: 30
      delay: 10

    - name: ğŸ“ Set variable for the newest backup file
      ansible.builtin.set_fact:
        newest_backup_file: "{{ found_files.files[0].path }}"
        
    - name: ğŸ“¤ Copy the newest backup file to the network share
      ansible.windows.win_copy:
        src: "{{ newest_backup_file }}"
        dest: "{{ network_share_path }}"
        remote_src: true
        
    - name: ğŸ§¹ Clean up old local backup files (older than {{ retention_days }} days)
      ansible.windows.win_find:
        paths: "{{ local_backup_path }}"
        file_type: file
        age: "{{ retention_days }}d"
        pattern: "{{ temp_zip_pattern }}"
      register: old_local_backups

    - name: ğŸ—‘ï¸ Delete found old local backup files
      ansible.windows.win_file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_local_backups.files }}"
      loop_control:
        label: "Deleting local file {{ item.path | split('\\') | last }}"
