---
- name: Automated Jellyfin Backup (Local Staging + Explicit Share Credentials)
  # Target the specific Windows Server where Jellyfin is installed
  hosts: server2k19.reisingers.com
  gather_facts: no

  vars:
    # --- JELLYFIN & LOCAL CONFIGURATION ---
    jellyfin_service_name: "JellyfinServer" # Standard service name
    # Default data path for a standard Windows installation
    jellyfin_data_path: "C:\\ProgramData\\Jellyfin\\Server" 
    local_backup_root: "C:\\Temp\\Jellyfin_Backup_Root" # Use a dedicated temp location
    local_staging_path: "{{ local_backup_root }}\\Staging"
    max_backups_to_keep: 10 # Keep 10 backups on the network share
    
    # --- NETWORK SHARE CONFIGURATION ---
    # NOTE: These values must be provided securely at runtime (e.g., via Ansible Vault/Semaphore)
    share_username: "" # Expected to be passed as ansible_share_username
    share_password: "" # Expected to be passed as ansible_share_password
    final_network_share: "\\\\kevireis-home\\i$\\Applications\\Jellyfin\\Backup"
    
    # Drive letter for temporary mapping (Must be unused)
    mapped_drive_letter: "Y" # Using Y: to avoid potential Z: conflict

    # Internal variable generation (uses controller time for unique name)
    current_timestamp: "{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M') }}"
    local_backup_file: "{{ local_backup_root }}\\{{ 'Jellyfin_Backup_' + current_timestamp + '.zip' }}"
    final_backup_file: "{{ mapped_drive_letter }}:\\{{ 'Jellyfin_Backup_' + current_timestamp + '.zip' }}"

  tasks:

    - name: Ensure local temporary and staging directories exist
      ansible.windows.win_file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ local_backup_root }}"
        - "{{ local_staging_path }}"

    - name: Execute Jellyfin Backup and Network Copy Script (Single PowerShell Block)
      ansible.windows.win_powershell:
        script: |
          # --- Configuration (Pulled from Ansible variables) ---
          $jellyfinService = '{{ jellyfin_service_name }}'
          $jellyfinDataPath = '{{ jellyfin_data_path }}'
          $localStagingPath = '{{ local_staging_path }}'
          $localBackupFile = '{{ local_backup_file }}'
          $maxBackups = {{ max_backups_to_keep }}
          $finalNetworkShare = '{{ final_network_share }}'
          $mappedDriveLetter = '{{ mapped_drive_letter }}'
          $finalBackupFile = '{{ final_backup_file }}'
          $shareUsername = '{{ share_username }}'
          $sharePassword = '{{ share_password }}'
          $cacheExclusions = @('cache', 'temp', 'metadata') # Folders to exclude from backup
          
          # --- Helper Functions ---
          function Restart-Services {
              Write-Host "Attempting to restart Jellyfin Media Server service..."
              Start-Service -Name $jellyfinService -ErrorAction SilentlyContinue
          }
          
          # --- 1. Stop Jellyfin service ---
          Write-Host "Stopping Jellyfin Media Server service ($jellyfinService)..."
          Stop-Service -Name $jellyfinService -Force -ErrorAction Stop
          Start-Sleep -Seconds 5
          
          # --- 2. Copy Jellyfin data (excluding cache/temp) to staging ---
          Write-Host "Copying Jellyfin data from $jellyfinDataPath to staging folder $localStagingPath..."
          # Use robocopy with exclusions for cache/temp/metadata
          # /MIR (Mirror) is powerful, but we must ensure we exclude the necessary subdirectories.
          robocopy "$jellyfinDataPath" "$localStagingPath" /MIR /XD $cacheExclusions | Out-Null
          
          # Check staging contents
          $StagingCount = (Get-ChildItem -Path $localStagingPath -Force | Measure-Object).Count
          if ($StagingCount -lt 5) { # Check for a minimum count (e.g., 5 essential folders)
              Write-Host "CRITICAL ERROR: Staging folder appears nearly empty or inaccessible. Source path ($jellyfinDataPath) is likely incorrect. Exiting."
              Restart-Services
              exit 1
          }
          Write-Host "Staging successful. Items copied: $StagingCount"

          # --- 3. Create ZIP from staging ---
          Write-Host "Creating ZIP backup at $localBackupFile ..."
          try {
              if (Test-Path $localBackupFile) { Remove-Item $localBackupFile -Force }
              # Compress all contents of staging folder
              Get-ChildItem -Path "$localStagingPath\*" | Compress-Archive -DestinationPath $localBackupFile -Force
          }
          catch {
              Write-Host "CRITICAL ERROR: Failed to compress ZIP. $($_.Exception.Message). Exiting."
              Restart-Services
              exit 1
          }

          # --- 4. Clean staging folder ---
          Write-Host "Cleaning up staging folder $localStagingPath..."
          Remove-Item "$localStagingPath\*" -Recurse -Force

          # --- 5. Restart Jellyfin service ---
          Restart-Services
          
          # --- 6. Map Network Drive and Copy ---
          Write-Host "Attempting to map network drive ${mappedDriveLetter}: to ${finalNetworkShare}..."
          cmd.exe /c net use ${mappedDriveLetter}: /delete /y | Out-Null
          cmd.exe /c net use ${mappedDriveLetter}: "${finalNetworkShare}" "${sharePassword}" /user:"${shareUsername}" /persistent:no
          
          if ($LASTEXITCODE -ne 0) {
              Write-Host "CRITICAL ERROR: Failed to map network drive. Code $LASTEXITCODE. Check share credentials. Exiting."
              Remove-Item $localBackupFile -Force -ErrorAction SilentlyContinue
              exit 1
          }
          Write-Host "Network drive mapped successfully."

          Write-Host "Copying local backup to network share..."
          try {
              Copy-Item -Path $localBackupFile -Destination $finalBackupFile -Force
          } catch {
              Write-Host "CRITICAL ERROR: Failed to copy file to network share. $($_.Exception.Message)"
              cmd.exe /c net use ${mappedDriveLetter}: /delete /y | Out-Null
              Remove-Item $localBackupFile -Force -ErrorAction SilentlyContinue
              exit 1
          }

          # --- 7. Retention on network share ---
          Write-Host "Cleaning up old NETWORK backups, keeping only the last $maxBackups..."
          $backups = Get-ChildItem -Path ${mappedDriveLetter}:\\ -Filter "Jellyfin_Backup_*.zip" | Sort-Object LastWriteTime -Descending
          if ($backups.Count -gt $maxBackups) {
              $backups | Select-Object -Skip $maxBackups | ForEach-Object {
                  Write-Host "Deleting old network backup: $($_.FullName)"
                  Remove-Item $_.FullName -Force
              }
          }

          # --- 8. Final Cleanup (Local ZIP and Drive) ---
          Write-Host "Removing local file $localBackupFile and unmapping drive ${mappedDriveLetter}: ..."
          Remove-Item $localBackupFile -Force -ErrorAction SilentlyContinue
          cmd.exe /c net use ${mappedDriveLetter}: /delete /y | Out-Null
          
          Write-Host "Jellyfin Backup and Transfer completed successfully!"

      register: ps_output
