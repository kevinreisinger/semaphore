---
- name: Backup HAOS Backups to Network Share
  hosts: server2k19.reisingers.com
  gather_facts: no

  vars:
    # NOTE: These variables are used as direct UNC paths
    source_share: '\\haos01\backup'
    destination_share: '\\kevireis-home\i$\Applications\Haos\Backup'
    share_username: '' # Provide username if needed for authentication
    share_password: '' # Provide password if needed for authentication
    max_backups_to_keep: 10

  tasks:
    - name: Copy HAOS backups via UNC paths and apply retention
      ansible.windows.win_powershell:
        parameters:
          source_share: "{{ source_share }}"
          destination_share: "{{ destination_share }}"
          share_username: "{{ share_username }}"
          share_password: "{{ share_password }}"
          max_backups_to_keep: "{{ max_backups_to_keep }}"
        script: |
          param(
            [string]$source_share,
            [string]$destination_share,
            [string]$share_username,
            [string]$share_password,
            [int]$max_backups_to_keep
          )

          Write-Host "=== Starting HAOS backup copy process (UNC Method) ==="

          $source_path = $source_share
          $destination_path = $destination_share
          $robocopy_log = "C:\Temp\HAOS_Backup_Copy_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

          # --- Step 1: Handle Authentication (If credentials provided) ---
          if (-not [string]::IsNullOrWhiteSpace($share_username)) {
            Write-Host "Authenticating UNC paths using provided credentials..."
            try {
                # This uses net use command *without* a drive letter to authenticate the current session context.
                # 
                cmd.exe /c "net use $source_share /user:$share_username $share_password" | Out-Null
                cmd.exe /c "net use $destination_share /user:$share_username $share_password" | Out-Null

                if ($LASTEXITCODE -ne 0) {
                    Write-Host "FATAL ERROR: Failed to authenticate to network share (Net Use Exit Code $LASTEXITCODE)."
                    exit 1
                }
            }
            catch {
                Write-Host "FATAL ERROR: Failed to handle network authentication."
                exit 1
            }
          } else {
            Write-Host "No credentials provided. Copying using current WinRM user context."
          }


          # --- Step 2: Copy Files using Robocopy (UNC to UNC) ---
          Write-Host "Executing robocopy from $source_path to $destination_path..."
          
          # CRITICAL CHANGE: Using /MIR (Mirror) for aggressive copying.
          # /R:1 /W:3 for retries, /V verbose, /NP no progress bar, /LOG+ for append
          robocopy $source_path $destination_path /MIR /R:1 /W:3 /V /NP /LOG+:$robocopy_log

          $robocopy_exit_code = $LASTEXITCODE
          Write-Host "Robocopy finished with exit code $robocopy_exit_code."
          
          # CRITICAL CHECK: Fail the Ansible task if Robocopy failed due to permissions or critical errors
          if ($robocopy_exit_code -eq 5) {
            Write-Host "FATAL ERROR (Access Denied): Robocopy failed due to a permissions error. (Code 5)."
            exit 1
          }
          
          if ($robocopy_exit_code -gt 7) { 
            Write-Host "FATAL ERROR: Robocopy failed due to a critical error (Code $robocopy_exit_code)."
            exit 1
          }

          # --- Step 3: Apply Retention Policy ---
          Write-Host "Applying retention policy (keeping $max_backups_to_keep latest backups) on $destination_path..."
          
          try {
              $backups = Get-ChildItem -Path $destination_path -Include *.tar, *.tar.gz, *.zip -File -Recurse | Sort-Object LastWriteTime -Descending

              if ($backups.Count -gt $max_backups_to_keep) {
                $toDelete = $backups | Select-Object -Skip $max_backups_to_keep
                foreach ($file in $toDelete) {
                  Write-Host "Deleting old backup: $($file.FullName)"
                  Remove-Item $file.FullName -Force -ErrorAction SilentlyContinue
                }
              }
          } catch {
              Write-Host "WARNING: Failed to apply retention policy. Check destination path permissions for Get-ChildItem."
          }


          # --- Step 4: Clean Up Authentication Session and Dump Log ---
          if (-not [string]::IsNullOrWhiteSpace($share_username)) {
            Write-Host "Cleaning up network authentication..."
            cmd.exe /c "net use $source_share /delete" | Out-Null
            cmd.exe /c "net use $destination_share /delete" | Out-Null
          }

          Write-Host "=== HAOS backup copy completed successfully ==="
          
          # FORCE LOG DUMP INTO ANSIBLE OUTPUT
          Write-Output "--- ROBOCOPY LOG CONTENTS ---"
          Get-Content $robocopy_log -ErrorAction SilentlyContinue
          Write-Output "--- END ROBOCOPY LOG CONTENTS ---"

          exit 0
