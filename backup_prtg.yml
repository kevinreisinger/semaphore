---
- name: Run Existing PowerShell Script on Remote Windows Server
  # Change 'windows_server' to the exact hostname you want to target.
  hosts: server2k19.reisingers.com
  gather_facts: no
  
  # Ensure Ansible is configured for Windows management (WinRM)
  vars:
    # --- PRTG Configuration ---
    prtg_data_path: "C:\\ProgramData\\Paessler\\PRTG Network Monitor"
    max_backups: 10
    
    # --- Network Share Configuration (Use dedicated share credentials here) ---
    share_path: "\\\\kevireis-home\\i$\\Applications\\Utilities\\PRTG Network Monitor\\Backup"
    # IMPORTANT: Fill in the username and password that HAS WRITE ACCESS to the share
    share_username: ""
    share_password: ""
    
    # Use a mapped drive letter for the script to avoid UNC delegation issues
    mapped_drive_letter: "Z"
    backup_root: "{{ mapped_drive_letter }}:\\"
    
  tasks:
    - name: Execute PRTG Backup Script (In-Memory PowerShell)
      ansible.windows.win_powershell:
        script: |
          # --- Configuration (using Ansible variables) ---
          $prtgDataPath = "{{ prtg_data_path }}"
          $backupRoot = "{{ backup_root }}"
          $maxBackups = {{ max_backups }}
          $sharePath = "{{ share_path }}"
          $shareUsername = "{{ share_username }}"
          $sharePassword = '{{ share_password }}' # Plain text password for net use command

          $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm"
          $backupFile = Join-Path $backupRoot "PRTG_Backup_$timestamp.zip"
          
          # --- 1. Map Network Drive with Specified Credentials using net use (Most reliable) ---
          Write-Host "Attempting to map network drive $mapped_drive_letter to $sharePath with specified credentials..."
          
          # Remove any existing mapping for Z: silently
          net use {{ mapped_drive_letter }}: /delete /y | Out-Null
          
          # Map the new drive using net use, forcing the share credentials
          $mapResult = net use {{ mapped_drive_letter }}: "$sharePath" "$sharePassword" /user:"$shareUsername" /persistent:no
          
          if ($LASTEXITCODE -ne 0) {
              # If net use fails, Ansible must catch this
              Write-Error "CRITICAL ERROR (net use failed): Failed to map network drive. Code $LASTEXITCODE. Output: $mapResult"
              exit 1
          }
          Write-Host "Network drive mapped successfully."
          
          # --- 2. Report User Context ---
          Write-Host "Running under WinRM user: $env:USERNAME"
          Write-Host "Destination path (Mapped): $backupRoot"
          
          # === 3. CRITICAL PATH/PERMISSION CHECK ON MAPPED DRIVE ===
          try {
              # Check access to the mapped path
              $pathExists = Test-Path -Path $backupRoot -PathType Container
              
              if (!$pathExists) {
                  Write-Host "Mapped backup directory does not exist. Attempting to create it..."
                  New-Item -ItemType Directory -Path $backupRoot -Force | Out-Null
                  Write-Host "Directory created successfully."
              } else {
                  Write-Host "Backup directory access confirmed."
              }
          } catch {
              # If the folder check fails, exit loudly
              Write-Error "CRITICAL ERROR: Failed to access or create backup path '$backupRoot'. Check mapped drive availability. $($_.Exception.Message)"
              exit 1
          }
          
          # --- 4. Stop PRTG services ---
          Write-Host "Stopping PRTG services..."
          Stop-Service -Name "PRTGCoreService" -Force
          Stop-Service -Name "PRTGProbeService" -Force
          Start-Sleep -Seconds 5
          
          # --- 5. Create ZIP backup ---
          Write-Host "Creating backup at $backupFile ..."
          try {
              Compress-Archive -Path "$prtgDataPath\\*" -DestinationPath $backupFile -Force
              Write-Host "Compression attempt successful."
          } catch {
              # If Compress-Archive fails (file lock or path issue), report it.
              Write-Error "CRITICAL ERROR: Failed to compress and write ZIP file. Compression failed. $($_.Exception.Message)"
              exit 1
          }
          
          # --- 6. Start PRTG services ---
          Write-Host "Restarting PRTG services..."
          Start-Service -Name "PRTGCoreService"
          Start-Service -Name "PRTGProbeService"
          
          # --- 7. Cleanup ---
          Write-Host "Cleaning up old backups..."
          # ... (rest of cleanup logic)
          $backups = Get-ChildItem -Path $backupRoot -Filter "PRTG_Backup_*.zip" |
                      Sort-Object LastWriteTime -Descending
          
          if ($backups.Count -gt $maxBackups) {
              $toDelete = $backups | Select-Object -Skip $maxBackups
              foreach ($file in $toDelete) {
                  Write-Host "Deleting old backup: $($file.FullName)"
                  Remove-Item $file.FullName -Force
              }
          }
          
          # --- 8. Unmap Drive ---
          Write-Host "Unmapping network drive Z:..."
          # Use net use /delete again, capturing output to prevent errors if the mapping is already gone.
          net use Z: /delete /y | Out-Null
          
          Write-Host "Backup completed successfully!"
      register: ps_output
      
    - name: Display PowerShell script output
      ansible.builtin.debug:
        var: ps_output
